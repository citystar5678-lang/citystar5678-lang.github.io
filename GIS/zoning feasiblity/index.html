<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Brooklyn Parcel Buildable Envelope Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height:100vh; }
    .popup-title { font-weight:bold; margin-bottom:6px; }
    .info-table td { padding:2px 6px; }
    .legend {
      background:white;
      padding:8px 10px;
      line-height:1.4;
      border-radius:6px;
      box-shadow:0 1px 6px rgba(0,0,0,.15);
      font-size:13px;
    }
    .legend div { margin-bottom:4px; }
    .legend span {
      display:inline-block;
      width:14px;
      height:14px;
      margin-right:6px;
      border-radius:3px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ------------------ MAP ------------------
    const map = L.map("map").setView([40.6782, -73.9442], 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // ------------------ ZONING COLORS ------------------
    const zoningColors = {
      "R1": "#4b7bec", "R2": "#3867d6", "R3": "#45aaf2",
      "R4": "#26de81", "R5": "#20bf6b", "R6": "#f7b731",
      "R7": "#fa8231", "R7A": "#f39c12", "R8": "#eb3b5a",
      "R9": "#8854d0", "C":  "#a55eea"
    };
    function getZoningColor(zone) {
      if (!zone) return "#9e9e9e";
      const key = Object.keys(zoningColors).find(z => zone.startsWith(z));
      return key ? zoningColors[key] : "#9e9e9e";
    }

    // ------------------ FEASIBILITY COLORS ------------------
    function getFeasibilityColor(v) {
      if (v === "High") return "#27ae60";
      if (v === "Medium") return "#e6a100";
      if (v === "Constrained") return "#c0392b";
      return "#9e9e9e";
    }

    // ------------------ BUILDABLE SF COLORS ------------------
    function getBuildableColor(sf) {
      if (!sf) return "#999";
      if (sf > 20000) return "#1e8449";
      if (sf > 10000) return "#f39c12";
      return "#c0392b";
    }

    // ------------------ FLOOD LAYERS ------------------
    const shallow = L.geoJSON(null, { style:{color:"#3fa7f5",weight:1,fillOpacity:.25}, interactive:false });
    const deep = L.geoJSON(null, { style:{color:"#1b6cc2",weight:1,fillOpacity:.35}, interactive:false });

    Promise.all([
      fetch("shallow_flooding.geojson").then(r=>r.json()),
      fetch("deeper_flooding.geojson").then(r=>r.json())
    ]).then(([shallowData, deepData])=>{
      shallow.addData(shallowData);
      deep.addData(deepData);
    });

    // ------------------ PARCELS ------------------
    let feasibilityLayer, zoningOutlineLayer;

    fetch("bk_buildable.geojson")
      .then(r=>r.json())
      .then(data=>{
        // Feasibility / Buildable fill layer
        feasibilityLayer = L.geoJSON(data,{
          style:f=>({
            fillColor:getBuildableColor(f.properties?.buildable_sf),
            fillOpacity:0.45,
            color:"#555",
            weight:0.5
          }),
          onEachFeature:(feature,layer)=>{
            const p = feature.properties || {};
            const badgeColor = getFeasibilityColor(p.feasibility);
            const popup = `
              <div class="popup">
                <div class="popup-title">Parcel</div>
                <table class="info-table">
                  <tr><td>BBL:</td><td>${p.BBL ?? "—"}</td></tr>
                  <tr><td>Address:</td><td>${p.Address ?? "—"}</td></tr>
                  <tr><td>ZIP:</td><td>${p.ZipCode ?? "—"}</td></tr>
                  <tr><td>Zoning:</td><td>${p.ZoneDist1 ?? "—"}</td></tr>
                  <tr><td>Lot Area:</td><td>${p.LotArea ?? "—"}</td></tr>
                  <tr><td>Max FAR:</td><td>${p.max_far ?? "—"}</td></tr>
                  <tr><td>Buildable SF:</td><td>${p.buildable_sf ?? "—"}</td></tr>
                  <tr>
                    <td>Feasibility:</td>
                    <td>
                      <span style="
                        display:inline-block;
                        padding:3px 8px;
                        border-radius:10px;
                        color:#fff;
                        background:${badgeColor};
                      ">
                        ${p.feasibility ?? "Unknown"}
                      </span>
                    </td>
                  </tr>
                </table>
              </div>`;
            layer.bindPopup(popup);
          }
        });

        // Zoning outlines layer
        zoningOutlineLayer = L.geoJSON(data,{
          style:f=>({
            color:getZoningColor(f.properties?.ZoneDist1),
            weight:1,
            fillOpacity:0
          })
        });

        // ------------------ LAYER CONTROLS ------------------
        const overlays = {
          "Shallow Flooding": shallow,
          "Deep Flooding": deep,
          "Buildable Envelope": feasibilityLayer,
          "Zoning Outlines": zoningOutlineLayer
        };
        L.control.layers(null, overlays, {collapsed:false}).addTo(map);

        // Add default visible layers
        feasibilityLayer.addTo(map);
        zoningOutlineLayer.addTo(map);

        // Zoom to study area
        map.fitBounds(feasibilityLayer.getBounds());
      })
      .catch(err=>console.error("Failed to load GeoJSON:", err));

    // ------------------ LEGEND ------------------
    const legend = L.control({position:"bottomright"});
    legend.onAdd=function(){
      const div = L.DomUtil.create("div","legend");
      div.innerHTML = "<b>Feasibility / Buildable SF</b><br/>";
      div.innerHTML += `<div><span style="background:#c0392b"></span>Low Buildable SF</div>`;
      div.innerHTML += `<div><span style="background:#f39c12"></span>Medium Buildable SF</div>`;
      div.innerHTML += `<div><span style="background:#1e8449"></span>High Buildable SF</div>`;
      div.innerHTML += `<hr style="margin:6px 0" />`;
      div.innerHTML += "<b>Zoning (outline)</b><br/>";
      Object.keys(zoningColors).forEach(k=>{
        div.innerHTML += `<div><span style="background:${zoningColors[k]}"></span>${k}</div>`;
      });
      div.innerHTML += `<hr style="margin:6px 0" />`;
      div.innerHTML += `<div><span style="background:#3fa7f5"></span>Shallow flooding</div>`;
      div.innerHTML += `<div><span style="background:#1b6cc2"></span>Deep flooding</div>`;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>


