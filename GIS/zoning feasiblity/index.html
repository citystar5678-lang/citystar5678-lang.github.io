<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Brooklyn Parcel Feasibility Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height:100vh; }

    .popup-title { font-weight:bold; margin-bottom:6px; }
    .info-table td { padding:2px 6px; }

    .legend {
      background:white;
      padding:8px 10px;
      line-height:1.4;
      border-radius:6px;
      box-shadow:0 1px 6px rgba(0,0,0,.15);
      font-size:13px;
    }
    .legend div { margin-bottom:4px; }
    .legend span {
      display:inline-block;
      width:14px;
      height:14px;
      margin-right:6px;
      border-radius:3px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ------------------ MAP ------------------
    const map = L.map("map").setView([40.6782, -73.9442], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // ------------------ ZONING COLORS ------------------
    // Add / adjust as needed — includes R2 now
    const zoningColors = {
      "R1": "#4b7bec",
      "R2": "#3867d6",
      "R3": "#45aaf2",
      "R4": "#26de81",
      "R5": "#20bf6b",
      "R6": "#f7b731",
      "R7": "#fa8231",
      "R7A": "#f39c12",
      "R8": "#eb3b5a",
      "R9": "#8854d0",
      "C":  "#a55eea"
    };

    function getZoningColor(zone) {
      if (!zone) return "#9e9e9e";
      const key = Object.keys(zoningColors).find(z => zone.startsWith(z));
      return key ? zoningColors[key] : "#9e9e9e";
    }

    // ------------------ FLOOD LAYERS ------------------
    const shallow = L.geoJSON(null, {
      style: { color:"#3fa7f5", weight:1, fillOpacity:.25 },
      interactive: false
    }).addTo(map);

    const deep = L.geoJSON(null, {
      style: { color:"#1b6cc2", weight:1, fillOpacity:.35 },
      interactive: false
    }).addTo(map);

    Promise.all([
      fetch("shallow_flooding.geojson").then(r => r.json()),
      fetch("deeper_flooding.geojson").then(r => r.json())
    ]).then(([shallowData, deepData]) => {
      shallow.addData(shallowData);
      deep.addData(deepData);
    });

    // ------------------ PARCELS ------------------
    fetch("bk_feasibility.geojson")
      .then(r => r.json())
      .then(data => {

        const parcelsLayer = L.geoJSON(data, {
          style: f => ({
            color: getZoningColor(f.properties?.ZoneDist1),
            weight: 1,
            fillOpacity: 0.25
          }),

          onEachFeature: (feature, layer) => {
            const p = feature.properties || {};

            const badgeColor =
              p.feasibility === "High" ? "#1e8f3a" :
              p.feasibility === "Medium" ? "#e6a100" :
              p.feasibility === "Constrained" ? "#c0392b" : "#777";

            const popup = `
              <div class="popup">
                <div class="popup-title">Parcel</div>
                <table class="info-table">
                  <tr><td>BBL:</td><td>${p.BBL ?? "—"}</td></tr>
                  <tr><td>Address:</td><td>${p.Address ?? "—"}</td></tr>
                  <tr><td>ZIP:</td><td>${p.ZipCode ?? "—"}</td></tr>

                  <tr><td>Zoning:</td><td>${p.ZoneDist1 ?? "—"}</td></tr>
                  <tr><td>Lot Area:</td><td>${p.LotArea ?? "—"}</td></tr>

                  <tr><td>Max FAR:</td><td>${p.max_far ?? "—"}</td></tr>
                  <tr><td>Est. Units:</td><td>${p.est_units ?? "—"}</td></tr>

                  <tr>
                    <td>Feasibility:</td>
                    <td>
                      <span style="
                        display:inline-block;
                        padding:3px 8px;
                        border-radius:10px;
                        color:#fff;
                        background:${badgeColor};
                      ">
                        ${p.feasibility ?? "Unknown"}
                      </span>
                    </td>
                  </tr>
                </table>
              </div>
            `;

            layer.bindPopup(popup);
          }
        }).addTo(map);

        // zoom to study area
        map.fitBounds(parcelsLayer.getBounds());
      })
      .catch(err => console.error("Failed to load GeoJSON:", err));

    // ------------------ LEGEND ------------------
    const legend = L.control({ position: "bottomright" });

    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = "<b>Zoning</b><br/>";

      Object.keys(zoningColors).forEach(k => {
        div.innerHTML += `
          <div><span style="background:${zoningColors[k]}"></span>${k}</div>
        `;
      });

      div.innerHTML += `
        <hr style="margin:6px 0" />
        <div><span style="background:#3fa7f5"></span>Shallow flooding</div>
        <div><span style="background:#1b6cc2"></span>Deep flooding</div>
      `;

      return div;
    };

    legend.addTo(map);
  </script>
</body>
</html>

