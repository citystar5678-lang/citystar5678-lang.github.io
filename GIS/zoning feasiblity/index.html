<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zoning Feasibility Map — Phase 3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body { margin: 0; font-family: Arial, Helvetica, sans-serif; }
    #map { height: 100vh; width: 100%; }

    .panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #fff;
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      max-width: 280px;
      z-index: 1000;
    }

    .panel h3 { margin: 0 0 6px; font-size: 15px; }
    .panel small { color: #666; }

    .table-wrap {
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding-top: 10px;
      max-height: 260px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td { padding: 4px 3px; text-align: right; }
    th { cursor: pointer; text-align: right; white-space: nowrap; }

    th:first-child, td:first-child { text-align: left; }

    tr:nth-child(even) { background: #fafafa; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
      font-size: 11px;
      margin-left: 4px;
    }
  </style>
</head>

<body>
  <div class="panel">
    <h3>
      Feasibility
      <span class="pill">Phase 3</span>
    </h3>
    <small>Click any parcel for buildable area + estimated units.</small>

    <div class="table-wrap">
      <table id="parcelTable">
        <thead>
          <tr>
            <th data-sort="id">Parcel</th>
            <th data-sort="buildable_sf">Buildable SF ⬍</th>
            <th data-sort="est_units">Units</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ---------------------------------------------
    // Example dataset (replace with your GeoJSON).
    // Each parcel must have: lot_area + max_far
    // ---------------------------------------------
    const parcels = [
      { id: "A101", lat: 40.72, lng: -73.99, lot_area: 40640, max_far: 6.0 },
      { id: "B202", lat: 40.7215, lng: -73.992, lot_area: 12000, max_far: 3.0 },
      { id: "C303", lat: 40.718, lng: -73.995, lot_area: 8000, max_far: 2.0 }
    ];

    // Assumptions — can later vary by zoning type
    const EFFICIENCY = 0.80;   // 80%
    const AVG_UNIT_SF = 900;   // average unit size

    // Derived metrics
    parcels.forEach(p => {
      p.max_floor_area = p.lot_area * p.max_far;
      p.buildable_sf   = p.max_floor_area * EFFICIENCY;
      p.est_units      = Math.floor(p.buildable_sf / AVG_UNIT_SF);
    });

    // ---------------------------------------------
    // Map
    // ---------------------------------------------
    const map = L.map("map").setView([40.72, -73.99], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    // ---------------------------------------------
    // Add markers + popup (Phase 3 popup content)
    // ---------------------------------------------
    parcels.forEach(p => {
      const popupHtml = `
        <b>Parcel ${p.id}</b><br/>
        <div style="margin-top:6px;font-size:13px;line-height:1.45">
          <div><b>Lot Area:</b> ${p.lot_area.toLocaleString()} sq ft</div>
          <div><b>FAR:</b> ${p.max_far}</div>
          <div><b>Buildable SF:</b> ${Math.round(p.buildable_sf).toLocaleString()}</div>
          <div><b>Estimated Units:</b> ${p.est_units}</div>
          <div style="margin-top:6px;color:#666">
            Estimate assumes <b>80% efficiency</b> & ~<b>900 sq ft</b> per unit.
          </div>
        </div>
      `;

      L.circleMarker([p.lat, p.lng], {
        radius: 8,
        fillColor: "#4f46e5",
        color: "#312e81",
        weight: 1,
        fillOpacity: 0.85
      })
      .addTo(map)
      .bindPopup(popupHtml);
    });

    // ---------------------------------------------
    // Table rendering + sorting by buildable_sf
    // ---------------------------------------------
    const tbody = document.querySelector("#parcelTable tbody");

    function renderTable(data) {
      tbody.innerHTML = "";
      data.forEach(p => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${p.id}</td>
          <td>${Math.round(p.buildable_sf).toLocaleString()}</td>
          <td>${p.est_units.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });
    }

    let sortDir = 1;
    function sortTable(key) {
      parcels.sort((a, b) =>
        a[key] > b[key] ? sortDir : a[key] < b[key] ? -sortDir : 0
      );
      sortDir *= -1;
      renderTable(parcels);
    }

    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.addEventListener("click", () => sortTable(th.dataset.sort));
    });

    renderTable(parcels);
  </script>
</body>
</html>

